In order to simplify the search in log files, an Elastic stack (previously known as ELK stack) could be used.
Log files are indexed in Elasticsearch, as soon as they are created on the filesystem, and filtered through Kibana great interface. 

*** WIP ***

## The search application

The search application is defined in the `docker-compose.yml` file. It basically defines the 3 services of the stack:

- logstash: specifies the log files to take into account (different paths for boot and build logs). It also filters and add additional attributes to each line of a log file.

- elasticsearch: index each line of the logs it receives 

- kibana: provides a fancy interface to search within the logs

## How it works

In this first version logstash is configured to check the new log files written to disk and parses them accordingly.

All the files with *.log* extension located in the *$PWD/log* folder are taken into account.

Note: this location is only used for the POC, the correct one needs to the decided afterwards

Kibana can then be used to search the logs in a very clean way. It's a very configurable tool which provides a lot of filters and visualisation tools.

## Running the stack

The following command needs to be run from the _search_ folder in order to launch the Elastic stack, that's it.

```
docker-compose up -d
```

The stack is expecting log file in the _search/log_ folder (specified by _$PWD/log_ in the docker-compose.yml file)

Note: the stack might take a couple of seconds before it's up and running

## Files ingestion

Now that the stack is running, we need to provide some log files so they can be indexed and searched.

In the _search/log_ folder, 2 files are present by default: _raw-sample-1.json_ and _raw-sample-1.json_.
Those files are exemples generated by Lava, they contain raw data and need to be processed before they can be sent to Elastic.

From this folder (_search/log_), run the following command:

```
$ docker container run -ti -v $PWD:/log lucj/kernelci-log raw-sample-1.json
File log-20171124T124620.log generated
Ready to be copied to the input folder of the Elastic stack
```

A file named _log-20171124T124620.log_ was produced from the _raw-sample-1.json_ one. This new file has been created in the input folder of the Elastic stack.

It will first be ingested by logstash and indexed in elasticsearch. Each record will look like the following.

```
{
  "lvl" => "results",
  "kernel" => "AGL-kernel-version",
  "tree" => "AGL-kernel-tree",
  "defconfig" => "defconfig+CONFIG_AGL=y",
  "branch" => "agl-branch",
  "dt" => "2017-11-20T14:05:43.785168",
  "result" => "pass",
  "path" => "/kernelci/log/log-20171124T124620.log",
  "@timestamp" => 2017-11-24T12:46:30.441Z,
  "@version" => "1",
  "host" => "1a4412211f21",
  "definition" => "lava",
  "arch" => "x86_64",
  "case" => "job
}
```

It's then very easy to search / filter logs through Kibana and to produce nice dashboards.

The Kibana interface is available on [http://localhost:5601/](http://localhost:5601/)

Note: some examples of Kibana dashboard will be added soon !

To index some other files, you need to copy the raw version in the _search/log_ folder and run the previous container on each of them.

## Status

This is a WIP dedicated to enhance the search within the log files.
Any feedback is welcome.

## Additional note

This stack does not need to have the whole application deployed as a Docker Compose application. It could be tested on a existing dev/test instance of kernelci.
